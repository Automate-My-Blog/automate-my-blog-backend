/**
 * Migration: Add seo_score_prediction column to blog_posts table
 *
 * This column stores the SEO quality score (0-100) for each blog post,
 * generated by GPT-4o analysis during content creation or re-analysis.
 */

import pg from 'pg';
import dotenv from 'dotenv';

dotenv.config();

const { Pool } = pg;

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

async function runMigration() {
  const client = await pool.connect();

  try {
    console.log('ðŸ” Checking if seo_score_prediction column exists...');

    // Check if column already exists
    const checkResult = await client.query(`
      SELECT column_name
      FROM information_schema.columns
      WHERE table_name = 'blog_posts'
      AND column_name = 'seo_score_prediction'
    `);

    if (checkResult.rows.length > 0) {
      console.log('âœ… Column seo_score_prediction already exists');
      return;
    }

    console.log('ðŸ“ Adding seo_score_prediction column to blog_posts table...');

    await client.query(`
      ALTER TABLE blog_posts
      ADD COLUMN seo_score_prediction INTEGER;
    `);

    console.log('âœ… Successfully added seo_score_prediction column');

    // Add comment to the column
    await client.query(`
      COMMENT ON COLUMN blog_posts.seo_score_prediction IS
      'SEO quality score (0-100) from GPT-4o analysis';
    `);

    console.log('âœ… Added column comment');

    // Create index for faster filtering by score
    await client.query(`
      CREATE INDEX idx_blog_posts_seo_score
      ON blog_posts(seo_score_prediction)
      WHERE seo_score_prediction IS NOT NULL;
    `);

    console.log('âœ… Created index on seo_score_prediction');

  } catch (error) {
    console.error('âŒ Migration failed:', error);
    throw error;
  } finally {
    client.release();
    await pool.end();
  }
}

runMigration()
  .then(() => {
    console.log('ðŸŽ‰ Migration completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('ðŸ’¥ Migration failed:', error);
    process.exit(1);
  });
