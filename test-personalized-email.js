import dotenv from 'dotenv';
import emailService from './services/email.js';
import db from './services/database.js';

dotenv.config();

/**
 * Test LLM-generated personalized email
 * Shows the full email generation flow with database context
 */

async function testPersonalizedEmail() {
  try {
    console.log('ðŸ§ª Testing Personalized Email Generation...\n');

    // Get a real user from database
    const userResult = await db.query(`
      SELECT id, email, first_name, last_name, plan_tier
      FROM users
      WHERE email = 'james@frankel.tv'
      LIMIT 1
    `);

    if (userResult.rows.length === 0) {
      console.log('âš ï¸  User james@frankel.tv not found, using test data...');

      // Send a test email with mock context
      console.log('ðŸ“§ Sending personalized low credit warning email...\n');

      // This will use the email service which:
      // 1. Fetches user context from database
      // 2. Generates dynamic content with GPT-4o
      // 3. Personalizes subject, body, and CTA
      // 4. Sends via SendGrid

      const testUserId = userResult.rows[0]?.id;

      if (testUserId) {
        const result = await emailService.sendLowCreditWarning(testUserId);

        console.log('âœ… Email sent successfully!\n');
        console.log('ðŸ“Š Email Details:');
        console.log(`   To: ${result.recipientEmail}`);
        console.log(`   Subject: ${result.subject}`);
        console.log(`   Message ID: ${result.messageId}`);
        console.log(`\nðŸ“¬ Check james@frankel.tv for the personalized email!\n`);
      } else {
        console.log('âš ï¸  No users found in database. Creating a demo email...\n');

        // Send directly with mock data to demonstrate
        const result = await emailService.send(
          'test-demo',
          'james@frankel.tv',
          {
            firstName: 'James',
            lastName: 'Frankel',
            planTier: 'free',
            availableCredits: 2,
            businessType: 'Technology Blog'
          },
          'low_credit_warning'
        );

        console.log('âœ… Demo email sent!\n');
        console.log('ðŸ“¬ Check james@frankel.tv\n');
      }

    } else {
      const user = userResult.rows[0];

      console.log('ðŸ‘¤ Found User:');
      console.log(`   Name: ${user.first_name} ${user.last_name}`);
      console.log(`   Email: ${user.email}`);
      console.log(`   Plan: ${user.plan_tier}`);
      console.log(`\nðŸ“§ Sending personalized email...\n`);

      // Send actual personalized email
      const result = await emailService.sendLowCreditWarning(user.id);

      console.log('âœ… Email sent successfully!\n');
      console.log('ðŸ“Š Generated Email Details:');
      console.log(`   To: ${result.recipientEmail}`);
      console.log(`   Subject: ${result.generatedContent?.subject || 'N/A'}`);
      console.log(`   Message ID: ${result.messageId}`);
      console.log(`\nðŸ“¬ Check ${user.email} for the personalized email!\n`);
      console.log('ðŸŽ¨ The email was generated by GPT-4o using:');
      console.log('   - Your name and account details');
      console.log('   - Your plan tier and usage history');
      console.log('   - Your business type and preferences');
      console.log('   - Dynamic subject line and personalized content\n');
    }

  } catch (error) {
    console.error('âŒ Test failed:', error.message);
    console.error(error);
    process.exit(1);
  }

  // Exit after email is sent
  setTimeout(() => process.exit(0), 2000);
}

testPersonalizedEmail();
